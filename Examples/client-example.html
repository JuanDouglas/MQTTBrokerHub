<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Broker Hub - Cliente de Exemplo</title>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, button {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .messages {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .message {
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            background-color: white;
        }
        .message-header {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        .context {
            background-color: #e7f3ff;
            border-left-color: #28a745;
        }
        .send-section {
            display: flex;
            gap: 10px;
            align-items: end;
        }
        .send-section > div {
            flex: 1;
        }
        .send-section button {
            width: auto;
            padding: 8px 20px;
        }
    </style>
</head>
<body>
    <h1>üöÄ MQTT Broker Hub - Cliente de Exemplo</h1>
    
    <div class="container">
        <h2>Configura√ß√£o da Conex√£o</h2>
        
        <div class="input-group">
            <label for="serverUrl">URL do Servidor:</label>
            <input type="text" id="serverUrl" value="https://localhost:8081/hub" placeholder="https://localhost:8081/hub">
        </div>
        
        <div class="input-group">
            <label for="sessionId">Session ID:</label>
            <input type="text" id="sessionId" placeholder="550e8400-e29b-41d4-a716-446655440000">
            <small>Deixe vazio para gerar automaticamente</small>
        </div>
        
        <button id="connectBtn" onclick="toggleConnection()">Conectar</button>
        
        <div id="connectionStatus" class="status disconnected">
            ‚ùå Desconectado
        </div>
    </div>
    
    <div class="container">
        <h2>Mensagens Recebidas</h2>
        <div id="messages" class="messages">
            <p>Nenhuma mensagem ainda...</p>
        </div>
        <button onclick="clearMessages()">Limpar Mensagens</button>
    </div>
    
    <div class="container">
        <h2>Enviar Mensagem</h2>
        <div class="send-section">
            <div class="input-group">
                <label for="messageText">Mensagem:</label>
                <textarea id="messageText" rows="3" placeholder="Digite sua mensagem aqui..."></textarea>
            </div>
            <div class="input-group">
                <label for="channelText">Canal (opcional):</label>
                <input type="text" id="channelText" placeholder="notifications">
            </div>
            <div>
                <button id="sendBtn" onclick="sendMessage()" disabled>Enviar</button>
            </div>
        </div>
    </div>

    <script>
        let connection = null;
        let currentSessionId = null;
        
        // Gerar UUID v4
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0,
                    v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // Atualizar status da conex√£o
        function updateConnectionStatus(connected, message = null) {
            const statusElement = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const sendBtn = document.getElementById('sendBtn');
            
            if (connected) {
                statusElement.className = 'status connected';
                statusElement.innerHTML = `‚úÖ Conectado - Session: ${currentSessionId}`;
                connectBtn.textContent = 'Desconectar';
                sendBtn.disabled = false;
            } else {
                statusElement.className = 'status disconnected';
                statusElement.innerHTML = message || '‚ùå Desconectado';
                connectBtn.textContent = 'Conectar';
                sendBtn.disabled = true;
            }
        }
        
        // Adicionar mensagem √† lista
        function addMessage(content, type = 'received', channel = null) {
            const messagesDiv = document.getElementById('messages');
            
            // Remover mensagem "Nenhuma mensagem"
            if (messagesDiv.children.length === 1 && messagesDiv.children[0].tagName === 'P') {
                messagesDiv.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            const channelText = channel ? ` [${channel}]` : '';
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    ${timestamp} - ${type === 'context' ? 'Contexto' : 'Nova Mensagem'}${channelText}
                </div>
                <div>${typeof content === 'string' ? content : JSON.stringify(content, null, 2)}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // Limpar mensagens
        function clearMessages() {
            document.getElementById('messages').innerHTML = '<p>Nenhuma mensagem ainda...</p>';
        }
        
        // Conectar/Desconectar
        async function toggleConnection() {
            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                await connection.stop();
                return;
            }
            
            const serverUrl = document.getElementById('serverUrl').value;
            let sessionId = document.getElementById('sessionId').value.trim();
            
            if (!sessionId) {
                sessionId = generateUUID();
                document.getElementById('sessionId').value = sessionId;
            }
            
            currentSessionId = sessionId;
            
            // Construir URL com sessionId
            const hubUrl = `${serverUrl}?sessionId=${sessionId}`;
            
            try {
                updateConnectionStatus(false, 'üîÑ Conectando...');
                
                connection = new signalR.HubConnectionBuilder()
                    .withUrl(hubUrl)
                    .withAutomaticReconnect()
                    .build();
                
                // Eventos da conex√£o
                connection.on("SetContext", (context) => {
                    console.log("Contexto recebido:", context);
                    addMessage(context, 'context');
                });
                
                connection.on("ReceiveMessage", (data) => {
                    console.log("Mensagem recebida:", data);
                    addMessage(data.Payload, 'received', data.Channel);
                });
                
                connection.onclose(() => {
                    updateConnectionStatus(false, '‚ùå Conex√£o perdida');
                });
                
                connection.onreconnecting(() => {
                    updateConnectionStatus(false, 'üîÑ Reconectando...');
                });
                
                connection.onreconnected(() => {
                    updateConnectionStatus(true);
                });
                
                await connection.start();
                updateConnectionStatus(true);
                
            } catch (error) {
                console.error('Erro na conex√£o:', error);
                updateConnectionStatus(false, `‚ùå Erro: ${error.message}`);
            }
        }
        
        // Enviar mensagem via API REST
        async function sendMessage() {
            const message = document.getElementById('messageText').value.trim();
            const channel = document.getElementById('channelText').value.trim() || null;
            
            if (!message) {
                alert('Digite uma mensagem antes de enviar!');
                return;
            }
            
            if (!currentSessionId) {
                alert('Conecte-se primeiro!');
                return;
            }
            
            try {
                const serverBase = document.getElementById('serverUrl').value.replace('/hub', '');
                const response = await fetch(`${serverBase}/Messages/Send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sessionId: currentSessionId,
                        message: message,
                        channel: channel
                    })
                });
                
                if (response.ok) {
                    document.getElementById('messageText').value = '';
                    addMessage(`Enviado: ${message}`, 'sent', channel);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('Erro ao enviar mensagem:', error);
                alert(`Erro ao enviar mensagem: ${error.message}`);
            }
        }
        
        // Permitir envio com Enter
        document.getElementById('messageText').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Gerar sessionId autom√°tico na inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            if (!document.getElementById('sessionId').value) {
                document.getElementById('sessionId').value = generateUUID();
            }
        });
    </script>
</body>
</html>